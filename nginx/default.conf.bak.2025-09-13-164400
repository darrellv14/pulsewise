upstream app_backend {
    # pakai nama container (container_name) atau service name. Keduanya valid.
    server pulsewise_backend:8000;
    keepalive 32;
}

upstream app_frontend {
    server pulsewise_frontend:3000;
    keepalive 32;
}

server {
  listen 80;
  server_name _;

  client_max_body_size 10m;

  # NextAuth (must be before generic /api rule)
  location /api/auth/ {
    proxy_http_version 1.1;
    proxy_set_header   Host $host;
    proxy_set_header   X-Real-IP $remote_addr;
    proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;
    proxy_pass         http://app_frontend;
  }

  # Proxy API -> FastAPI
  location /api/ {
    proxy_http_version 1.1;
    proxy_set_header   Host $host;
    proxy_set_header   X-Real-IP $remote_addr;
    proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;

    # strip prefix /api -> /health, /diaries, dst.
    rewrite ^/api/(.*)$ /$1 break;

    proxy_pass         http://app_backend;
  }

  # Human-facing auth pages (custom UI under /auth)
  location /auth/ {
    proxy_http_version 1.1;
    proxy_set_header   Host $host;
    proxy_set_header   X-Real-IP $remote_addr;
    proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;
    proxy_pass         http://app_frontend;
  }

  # Frontend Next.js
  location / {
    proxy_http_version 1.1;
    proxy_set_header   Host $host;
    proxy_set_header   X-Real-IP $remote_addr;
    proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;

    proxy_pass         http://app_frontend;
  }
}
